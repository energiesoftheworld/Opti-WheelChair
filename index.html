<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Opti-WheelChair</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
        }
        
        #joystick-zone {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 70%);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            touch-action: none;
        }

        #joystick-handle {
            width: 80px;
            height: 80px;
            background: #3b82f6;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #60a5fa;
            cursor: grab;
            transition: transform 0.1s;
        }

        #joystick-handle:active {
            background: #2563eb;
            cursor: grabbing;
        }

        .terminal-log {
            font-family: monospace;
            font-size: 0.8rem;
            border-left: 2px solid #22c55e;
            padding-left: 10px;
            height: 100px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-disconnected { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-connected { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
    </style>
</head>
<body class="flex flex-col items-center justify-between h-screen p-4 select-none">

    <!-- Header -->
    <div class="w-full max-w-md text-center space-y-4 mt-2">
        <h1 class="text-2xl font-bold tracking-widest text-blue-400">OPTI-WHEELCHAIR</h1>
        
        <div class="flex items-center justify-center space-x-4 bg-slate-800 p-3 rounded-lg border border-slate-700">
            <div id="status-dot" class="status-dot status-disconnected"></div>
            <span id="status-text" class="text-sm font-bold text-slate-300">DESCONECTAR</span>
        </div>

        <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg active:scale-95 transition-all shadow-lg border-b-4 border-blue-800">
            CONECTAR SILLA DE RUEDAS
        </button>
    </div>

    <!-- Joystick -->
    <div class="flex-grow flex items-center justify-center w-full">
        <div id="joystick-zone">
            <div id="joystick-handle"></div>
            <div class="absolute w-full h-[1px] bg-blue-900 top-1/2 left-0 pointer-events-none"></div>
            <div class="absolute h-full w-[1px] bg-blue-900 left-1/2 top-0 pointer-events-none"></div>
            <!-- Labels visuales -->
            <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-xs text-blue-500">W</div>
            <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs text-blue-500">S</div>
            <div class="absolute left-2 top-1/2 transform -translate-y-1/2 text-xs text-blue-500">A</div>
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-blue-500">D</div>
        </div>
    </div>

    <!-- Info y Logs -->
    <div class="w-full max-w-md space-y-2 mb-4">
        <div class="bg-slate-900 p-2 rounded border border-slate-700 text-center">
            <span class="text-xs text-cyan-300 block">COMANDO ACTUAL</span>
            <span id="last-cmd" class="text-white text-2xl font-bold tracking-widest">-</span>
        </div>
        
        <div id="logger" class="terminal-log text-slate-400 w-full rounded">
            <div>> terminal</div>
        </div>
    </div>

    <script>
        // UUIDs ESTANDAR (HM-10 / CC2541 / ESP32 BLE UART)
        // OJO: Si usas HC-05 no va a jalar directo, necesitas un módulo BLE (HM-10)
        const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
        const CHAR_UUID_TX = '0000ffe1-0000-1000-8000-00805f9b34fb';

        let bluetoothDevice;
        let writableCharacteristic;
        let isConnected = false;
        let lastSentCmd = ''; 

        // UI Refs
        const connectBtn = document.getElementById('connectBtn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const logger = document.getElementById('logger');
        const joystickZone = document.getElementById('joystick-zone');
        const joystickHandle = document.getElementById('joystick-handle');
        const lastCmdDisplay = document.getElementById('last-cmd');

        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            logger.appendChild(line);
            logger.scrollTop = logger.scrollHeight;
        }

        // --- BLUETOOTH ---
        connectBtn.addEventListener('click', async () => {
            if (isConnected) { disconnect(); return; }
            try {
                log('Buscando módulo BLE...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    // Filtro más permisivo para encontrar HM-10 genéricos
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                log('Conectando...');
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                writableCharacteristic = await service.getCharacteristic(CHAR_UUID_TX);
                onConnected();
            } catch (error) {
                log('Error: ' + error);
            }
        });

        function onConnected() {
            isConnected = true;
            statusText.textContent = "CONECTADO";
            statusText.classList.replace("text-slate-300", "text-green-400");
            statusDot.classList.replace("status-disconnected", "status-connected");
            connectBtn.textContent = "DESCONECTAR";
            connectBtn.classList.replace("bg-blue-600", "bg-red-600");
            connectBtn.classList.replace("border-blue-800", "border-red-800");
            log('Conectado al carro.');
        }

        function onDisconnected() {
            isConnected = false;
            statusText.textContent = "DESCONECTADO";
            statusText.classList.replace("text-green-400", "text-slate-300");
            statusDot.classList.replace("status-connected", "status-disconnected");
            connectBtn.textContent = "CONECTAR";
            connectBtn.classList.replace("bg-red-600", "bg-blue-600");
            connectBtn.classList.replace("border-red-800", "border-blue-800");
            log('Se perdió la conexión.');
        }

        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
        }

        async function sendChar(char) {
            if (!isConnected || !writableCharacteristic) return;
            // Solo enviar si cambió el comando para no saturar
            if (char === lastSentCmd) return;

            try {
                const encoder = new TextEncoder();
                // Tu arduino lee char por char, así que enviamos directo
                await writableCharacteristic.writeValue(encoder.encode(char));
                lastSentCmd = char;
                lastCmdDisplay.textContent = char === '0' ? 'STOP (0)' : `MOVIENDO: ${char.toUpperCase()}`;
                
                // Efecto visual en el display
                lastCmdDisplay.classList.add('text-green-400');
                setTimeout(() => lastCmdDisplay.classList.remove('text-green-400'), 200);
            } catch (error) {
                log('Fallo envío: ' + error);
            }
        }

        // --- JOYSTICK LÓGICA BARTOLITO ---
        let dragStart = null;
        const maxDist = 100;

        const handleStart = (e) => {
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            const rect = joystickZone.getBoundingClientRect();
            dragStart = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            updateJoystick(touch.clientX, touch.clientY);
        };

        const handleMove = (e) => {
            if (!dragStart) return;
            e.preventDefault();
            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            updateJoystick(touch.clientX, touch.clientY);
        };

        const handleEnd = () => {
            dragStart = null;
            joystickHandle.style.transform = `translate(-50%, -50%)`;
            sendChar('0'); // Enviar 0 al soltar
        };

        function updateJoystick(clientX, clientY) {
            if (!dragStart) return;

            let dx = clientX - dragStart.x;
            let dy = clientY - dragStart.y;
            const distance = Math.min(Math.hypot(dx, dy), maxDist);
            const angle = Math.atan2(dy, dx);

            const moveX = Math.cos(angle) * distance;
            const moveY = Math.sin(angle) * distance;
            
            joystickHandle.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

            // Lógica para determinar W, A, S, D
            // Si la distancia es muy corta, es zona muerta -> 0
            if (distance < 30) {
                sendChar('0');
                return;
            }

            // Determinar dirección dominante
            // Usamos valor absoluto para ver si es movimiento horizontal o vertical
            if (Math.abs(dx) > Math.abs(dy)) {
                // Horizontal
                if (dx > 0) sendChar('d'); // Derecha
                else sendChar('a');        // Izquierda
            } else {
                // Vertical
                if (dy > 0) sendChar('s'); // Abajo (en pantalla Y crece hacia abajo)
                else sendChar('w');        // Arriba
            }
        }

        joystickZone.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        joystickZone.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('touchend', handleEnd);

    </script>
</body>
</html>